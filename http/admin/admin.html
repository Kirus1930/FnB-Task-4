<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <style>
        /* Стили для чата */
        #chat { 
            margin: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 500px;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
        }
        #messageInput {
            width: 70%;
            padding: 8px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Админ-панель</h1>
    
    <!-- Секция чата -->
    <div id="chat">
        <h3>Чат поддержки</h3>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Введите сообщение...">
        <button onclick="sendMessage()">Отправить</button>
    </div>

    <script>
        // Подключение к WebSocket (порт 3501)
        const socket = new WebSocket('ws://localhost:3501');
        const messagesDiv = document.getElementById('messages');

        // Обработка входящих сообщений
        socket.onmessage = (event) => {
            messagesDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${event.data}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        // Отправка сообщений
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim()) {
                socket.send(`Админ: ${input.value}`);
                input.value = '';
            }
        }

        // Отправка по Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
    <!-- Добавьте после секции чата -->
    <div id="products-management">
        <h2>Управление товарами</h2>
    
        <!-- Форма добавления/редактирования -->
        <form id="productForm" onsubmit="handleSubmit(event)">
            <input type="hidden" id="productId">
            <input type="text" id="name" placeholder="Название" required>
            <input type="number" id="price" placeholder="Цена" required>
            <textarea id="description" placeholder="Описание"></textarea>
            <input type="text" id="categories" placeholder="Категории (через запятую)">
            <button type="submit">Сохранить</button>
            <button type="button" onclick="clearForm()">Отмена</button>
        </form>

        <!-- Список товаров -->
        <div id="productsList"></div>
    </div>

    <script>
        // Загрузка товаров
        async function loadProducts() {
            const response = await fetch('/api/products');
            const products = await response.json();
            renderProducts(products);
        }

        // Отображение товаров
        function renderProducts(products) {
            const container = document.getElementById('productsList');
            container.innerHTML = products.map(product => `
                <div class="product-item">
                    <h3>${product.name} (ID: ${product.id})</h3>
                    <p>Цена: ${product.price} руб.</p>
                    <button onclick="editProduct(${product.id})">Редактировать</button>
                    <button onclick="deleteProduct(${product.id})">Удалить</button>
                </div>
            `).join('');
        }

        // Удаление товара
        async function deleteProduct(id) {
            await fetch(`/api/products/${id}`, { method: 'DELETE' });
            loadProducts();
        }

        // Редактирование товара
        async function editProduct(id) {
            const response = await fetch(`/api/products/${id}`);
            const product = await response.json();
            document.getElementById('productId').value = product.id;
            document.getElementById('name').value = product.name;
            document.getElementById('price').value = product.price;
            document.getElementById('description').value = product.description;
            document.getElementById('categories').value = product.categories.join(', ');
        }

        // Обработка формы
        async function handleSubmit(e) {
            e.preventDefault();
            const product = {
                name: document.getElementById('name').value,
                price: parseInt(document.getElementById('price').value),
                description: document.getElementById('description').value,
                categories: document.getElementById('categories').value.split(',').map(s => s.trim())
            };

            const id = document.getElementById('productId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/products/${id}` : '/api/products';

            await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(product)
            });

            clearForm();
            loadProducts();
        }

        // Очистка формы
        function clearForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
        }

        // Инициализация
        loadProducts();
    </script>

    <script>
        const ws = new WebSocket('ws://localhost:8080/chat?role=admin');
    
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const div = document.createElement('div');
            div.innerHTML = `[${msg.from}] ${msg.text}`;
            document.getElementById('messages').appendChild(div);
        };
  
        function sendMessage() {
            const input = document.getElementById('messageInput');
            ws.send(JSON.stringify({ text: input.value }));
            input.value = '';
        }
    </script>
</body>
</html>